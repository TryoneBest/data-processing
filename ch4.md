# NumPy基础：数组和矢量计算

NumPy(Numerical Python的简称)是高性能科学计算和数据分析的基础包。部分功能：

- ndarray，一个具有矢量算数运算和复杂广播能力的快速且节省空间的多维数组
- 用于对整组数据进行快速运算的标准数学函数(无需编写循环)
- 用于读写磁盘数据的工具以及用于操作内存映射文件的工具
- 线性代数、随机数生成以及傅里叶变换功能
- 用于集成由C、C++、Fortran等语言编写的代码的工具

对于大部分数据分析应用而言，功能集中于：

- 用于数据整理和清理、子集构造和过滤、转换等快速的矢量化数组运算
- 常用的数组算法，如排序、唯一化、集合运算等
- 高效的描述统计和数据聚合/摘要运算
- 用于异构数据集的合并/连接运算的数据对齐和关系型数据运算
- 将条件逻辑表述为数组表达式(而不是带有if-elif-else分支的循环)
- 数据的分组运算(聚合、转换、函数应用等)

## NumPy的ndarray：一种多维数组对象

N维数组对象，可以对整块数据执行一些数学运算。里面所有元素都必须是相同类型的，每个数组都有一个shape(一个表示各维度大小的元组)和一个dtype(一个用于说明数据类型的对象)。

### 创建ndarray

使用array函数，接受一切序列型的对象产生一个新的含有传入数据的NumPy数组:

```Python
data1 = [6, 7.5, 8, 0, 1]
arr1 = np.array(data1)
print(arr1) # array([6., 7.5, 8., 0., 1.])
```

嵌套序列会转换成多维数组，除非显式说明，np.array会尝试为新建数组推断出比较合适的数据类型，比如上文为float因为含有7.5的数据。数据类型保存在dtype中

除array函数外，zeros和ones分别创建指定长度或形状的全0或全1数组；empty可以创建一个没有任何具体值的数组(未初始化的垃圾值)。参数为一个表示形状的元组：

`np.zeros((3, 6))` `np.empty((2, 3, 2))`

arange是Python内置函数range的升级版，按序创建0到参数值的自然数数组

`np.arange(15)`

| 函数              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| array             | 将输入数据转换为ndarray；推断或显式指定dtype；默认直接复制输入数组 |
| asarray           | 将输入转换为ndarray，如果本身就是一个ndarray则不进行复制     |
| arange            | 类似于range，但返回的是一个ndarray而不是列表                 |
| ones、ones_like   | 根据指定的形状和dtype创建一个全1数组。ones_like以另一个数组为参数根据其形状和dtype创建新数组 |
| zeros、zeros_like | 类似于ones和ones_like，只不过是产生全0数组                   |
| empty、empty_like | 创建新数组，只分配内存空间但不填充任何值(垃圾值)             |
| eye、identity     | 创建一个正方的NxN单位矩阵(对角线为1，其余为0)                |

### ndarray的数据类型

dtype是一个特殊的对象，它含有ndarray将一块内存解释为特定数据类型所需的信息，大多数情况下直接映射到相应的机器表示

数值型dtype的命名方式：一个类型名(int、float等)跟一个表示元素位长的数字

| 类型                              | 类型代码     | 说明                                                   |
| --------------------------------- | ------------ | ------------------------------------------------------ |
| int8、uint8                       | i1、u1       | 有符号和无符号的8位整型                                |
| int16、uint16                     | i2、u2       | 有符号和无符号的16位整型                               |
| int32、uint32                     | i4、u4       | 有符号和无符号的32位整型                               |
| int64、uint64                     | i8、u8       | 有符号和无符号的64位整型                               |
| float16                           | f2           | 半精度浮点数                                           |
| float32                           | f4 or f      | 标准的单精度浮点数，与C的float兼容                     |
| float64                           | f8 or d      | 标准的双精度浮点数，与C的double和Python的float对象兼容 |
| float128                          | f16 or g     | 扩展精度浮点数                                         |
| complex64、complex128、complex256 | c8、c16、c32 | 分别用两个32位、64位或128位浮点数表示的复数            |
| bool                              | ?            | 存储True和False值的布尔类型                            |
| object                            | O            | Python对象类型                                         |
| string_                           | S            | 固定长度的字符串类型，每个字符一个字节，如S10          |
| unicode_                          | U            | 固定长度的unicode类型，跟字符串定义方式一样            |

根据np.astype方法显式转换其dtype，浮点数转为整型会截断，全数字字符串数组可转为数值形式，失败会引发TypeError；使用astype无论如何都会创建一个新的数组

### 数组和标量之间的运算

矢量化(vectorization)不编写循环对数据执行批量运算，比如arr+arr，arr / 2

不同大小的数组之间的运算叫做广播(broadcasting)

### 基本的索引和切片

一维数组的索引和切片和Python列表类似，比如arr[5]，arr[5:10]；当把标量值赋值给切片时，该值会自动传播；跟Python列表的区别在于np数组切片是原始数组的视图，即任何修改都会直接反映到源数组上，这是为了性能和内存考虑，因为NumPy的设计目的是处理大数据；如果想要得到切片的副本需要显式的复制操作，比如arr[5:10].copy()

在多维数组中，索引位置为依次的低维数组；可以一次传入多个切片

### 布尔索引

比如一个名字数组names = ['Bob', 'Joe', 'Will', 'Bob', 'Will', 'Joe', 'Joe']和一个(7, 4)形状的数组一一对应，想取后者中对应Bob的数组，可以用布尔索引，即arr[names == 'Bob']，其中的索引为布尔型数组[True, False, False, True, False, False, False]，用于索引的布尔型数组必须与被索引的轴长度一致

可以跟切片混用，比如arr[names == 'Bob', 2:]，会在结果数组中切片

根据布尔索引选取数组中的数据，总是创建数据的副本，即使返回一模一样的数组

通过布尔数组可以设置值，比如把所有负数设置为0：data[data < 0] = 0

### 花式索引

Fancy indexing是一个NumPy术语，指的是利用整数数组进行索引

为了以特定顺序选取子集，传入一个特定顺序的整数列表

如果一次传入多个列表，比如传入[1, 5, 7, 2]和[0, 3, 1, 2]，返回结果是一个一维数组，对应输入的各个元组，比如结果[4, 23, 29, 10]中，4对应(1, 0)，23对应(5, 3)等；如果需要的是选取矩形区域，可以有两种方法：

1. `arr[[1, 5, 7, 2]][:, [0, 3, 1, 2]]`
2. `arr[np.ix_([1, 5, 7, 2], [0, 3, 1, 2])]`

花式索引跟切片不一样，总是将数据复制到新数组中

### 数组转置和轴对换

转置(transpose)是重塑的一种特殊形式，它返回的是源数据的视图(不会进行任何复制操作)

数组有个特殊的T属性，在进行矩阵计算时经常需要用到该操作，比如用np.dot计算矩阵内积`np.dot(arr.T, arr)`

对于高维数组，transpose需要得到一个由轴编号组成的元组才能对这些轴进行转置

简单的转置可以用.T，还有个swapaxes方法接受一对轴编号，返回的也是源数据的视图

## 通用函数：快速的元素级数组函数

通用函数(ufunc)是一种对ndarray中的数据执行元素级运算的函数

一元ufunc

| 函数                                              | 说明                                                         |
| ------------------------------------------------- | ------------------------------------------------------------ |
| abs、fabs                                         | 计算整数、浮点数或复数的绝对值；非复数fabs更快               |
| sqrt                                              | 计算各元素的平方根，相当于arr ** 0.5                         |
| square                                            | 计算各元素的平方，相当于arr ** 2                             |
| exp                                               | 计算各元素的指数e^x                                          |
| log、log10、log2、log1p                           | 分别为自然对数、底数为10、底数为2、log(1+x)                  |
| sign                                              | 计算各元素的正负号                                           |
| ceil                                              | 计算各元素的ceiling值，即大于等于该值的最小整数              |
| floor                                             | 计算各元素的floor值，即小于等于该值的最大整数                |
| rint                                              | 将各元素值四舍五入至最接近的整数，保留dtype                  |
| modf                                              | 将数组的小数和整数部分以两个独立数组的形式返回               |
| isnan                                             | 返回一个表示"哪些值是NaN"的布尔型数组                        |
| isfinite、isinf                                   | 分别返回一个表示"哪些元素是有穷的(非inf非NaN)"、"哪些元素是无穷的"的布尔型数组 |
| cos、cosh、sin、sinh、tan、tanh                   | 普通型和双曲型三角函数                                       |
| arccos、arccosh、arcsin、arcsinh、arctan、arctanh | 反三角函数                                                   |
| logical_not                                       | 计算各元素not x的真值，相当于-arr                            |

二元ufunc

| 函数                                                       | 说明                                                         |
| ---------------------------------------------------------- | ------------------------------------------------------------ |
| add                                                        | 将数组中对应的元素相加                                       |
| subtract                                                   | 从第一个数组中减去第二个数组中的元素                         |
| multiply                                                   | 数组元素相乘                                                 |
| divide、floor_divide                                       | 除法、向下圆整除法(丢弃余数)                                 |
| power                                                      | 对第一个数组里的元素A和第二个数组里的元素B计算A^B            |
| maximun、fmax                                              | 元素级的最大值计算，fmax忽略NaN                              |
| minimum、fmin                                              | 元素级的最小值计算，fmin忽略NaN                              |
| mod                                                        | 元素级的求模计算                                             |
| copysign                                                   | 将第二个数组中的值的符号复制给第一个数组中的值               |
| greater、greater_equal、less、less_equal、equal、not_equal | 执行元素级的比较运算，最终产生布尔型数组，相当于中缀运算符>、>=、<、<=、==、!= |
| logical_and、logical_or、logical_xor                       | 执行元素级的真值逻辑运算，相当于中缀运算符&、\|、^           |

## 利用数组进行数据处理

比如想在一组网格型的值上计算函数sqrt(x^2 + y^2)，np.meshgrid接受两个一维数组，产生两个二维矩阵，分别对应两个数组中的所有(x, y)对：`xs, ys = np.meshgrid(arr, arr)`，这样就转化为计算np.sqrt(xs ** 2 + ys ** 2)

### 将条件逻辑表述为数组运算

np.where函数是三元表达式x if condition else y的矢量化版本，用法：

```Python
xarr = np.array([1.1, 1.2, 1.3, 1.4, 1.5])
yarr = np.array([2.1, 2.2, 2.3, 2.4, 2.5])
cond = np.array([True, False, True, True, False])
```

如上3个数组，如果想根据cond里的布尔值来选取x或者y里的值，纯Python的表达式处理数据会很慢，可以用

```python
result = np.where(cond, xarr, yarr)
```

与if...else的三元表达式类似，第一个参数表示判断依据，第二个是判断成功选取的数组，第三个是判断失败，都是元素级的判断；其中判断依据可以是应用到元素级的标量值，比如说>0

### 数学和统计方法

mean和sum这类函数可以接受一个axis参数(计算该轴上的统计值)，最终结果为一个少一维的数组

![轴示意](.\img\ch4-1.png)

基本的数组统计方法

| 方法           | 说明                                                  |
| -------------- | ----------------------------------------------------- |
| sum            | 对数组中全部或某轴(axis)的元素求和，0长度的数组sum为0 |
| mean           | 算术平均数，0长度的数组mean为NaN                      |
| std、var       | 分别为标准差和方差，自由度可调                        |
| min、max       | 最大值和最小值                                        |
| argmin、argmax | 分别为最大和最小元素的索引                            |
| cumsum         | 所有元素的累计和                                      |
| cumprod        | 所有元素的累计积                                      |

### 用于布尔型数组的方法

在上述统计方法中，布尔值会被强制转换为1和0，所以sum可以用来对布尔型数组里的True计数

另外两个方法any和all，前者用于测试数组中是否存在一个或多个True，后者用来检查是否所有值都为True

### 排序

可以跟Python内置列表类型一样用sort排序，也可以在任意轴上排序，比如arr.sort(1)

顶级方法np.sort返回的是数组的已排序副本，就地排序会修改数组本身

### 唯一化以及其他的集合逻辑

数组的集合运算

| 方法              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| unique(x)         | 计算x中的唯一元素，并返回有序结果                            |
| intersect1d(x, y) | 计算x和y中的公共元素，并返回有序结果                         |
| union1d(x, y)     | 计算x和y的并集，并返回有序结果                               |
| in1d(x, y)        | 得到一个表示"x的元素是否包含于y"的布尔型数组                 |
| setdiff1d(x, y)   | 集合的差，即元素在x中且不在y中                               |
| setxor1d(x, y)    | 集合的对称差，即存在于一个数组中但不同时存在于两个数组中的元素 |

## 用于数组的文件输入输出

NumPy能够读写磁盘上的文本数据或二进制数据

### 将数组以二进制格式保存到磁盘

np.save和np.load是读写磁盘数组数据的两个主要函数

默认情况下，数组是以未压缩的原始二进制格式保存在扩展名为.npy的文件中的：`np.save('some_array', arr)`文件路径末尾没有扩展名会自动添加

然后就可以从文件中读取数组：`np.load('some_array.npy')`

`np.savez('array_archive.npz', a=arr, b=arr1)`np.savez可以将多个数组保存到一个压缩文件中

加载npz文件时，会得到类似字典的对象

### 存取文本文件

pandas的read_csv和read_table；np.loadtxt和np.genfromtxt加载数据到普通的NumPy数组中

## 线性代数

| 函数  | 说明                                                         |
| ----- | ------------------------------------------------------------ |
| diag  | 以一维数组的形式返回方阵的对角线(或非对角线)元素，或将一维数组转换为方阵 |
| dot   | 矩阵乘法                                                     |
| trace | 计算对角线元素的和                                           |
| det   | 计算矩阵行列式                                               |
| eig   | 计算方阵的本征值和本征向量                                   |
| inv   | 计算方阵的逆                                                 |
| pinv  | 计算矩阵的Moore-Penrose伪逆                                  |
| qr    | 计算QR分解                                                   |
| svd   | 计算奇异值分解(SVD)                                          |
| solve | 解线性方程组Ax-b，其中A为一个方阵                            |
| lstsq | 计算Ax = b的最小二乘解                                       |

## 随机数生成

| 函数        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| seed        | 确定随机数生成器的种子                                       |
| permutation | 返回一个序列的随机排列或返回一个随机排列的范围               |
| shuffle     | 对一个序列就地随机排列                                       |
| rand        | 产生均匀分布的样本值                                         |
| randint     | 从给定的上下限范围内随机选取整数                             |
| randn       | 产生正态分布(平均值为0，标准差为1)的样本值，类似于MATLAB接口 |
| binomial    | 产生二项分布的样本值                                         |
| normal      | 产生正态(高斯)分布的样本值                                   |
| beta        | 产生Beta分布的样本值                                         |
| chisquare   | 产生卡方分布的样本值                                         |
| qamma       | 产生Gamma分布的样本值                                        |
| uniform     | 产生在[0,1)中均匀分布的样本值                                |

